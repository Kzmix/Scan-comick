---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getAllSeriesSlugs,
  getSeriesBySlug,
  getChapterByNumber,
} from "@/lib/series";
import { getChapterImages } from "@/lib/chapter";

/* STATIC PATHS */
export async function getStaticPaths() {
  const paths = [];

  for (const slug of getAllSeriesSlugs()) {
    const series = getSeriesBySlug(slug);
    if (!series) continue;

    for (const ch of series.chapters) {
      paths.push({
        params: {
          slug,
          number: String(ch.number),
        },
      });
    }
  }

  return paths;
}

const { slug, number } = Astro.params;
const chapterNumber = Number(number);

const series = getSeriesBySlug(slug);
if (!series) throw new Error("Series not found");

const chapterNav = getChapterByNumber(series, chapterNumber);
if (!chapterNav) throw new Error("Chapter not found");

const chapterImages = getChapterImages(slug, chapterNumber);

const canonical = `https://example.com/series/${slug}/chapter/${chapterNumber}`;
---

<BaseLayout
  title={`${series.title} Chapter ${chapterNumber}`}
  description={`Baca ${series.title} Chapter ${chapterNumber}`}
  canonical={canonical}
>
  <main class="bg-zinc-950 text-zinc-100">

    <!-- BREADCRUMB -->
    <nav class="max-w-3xl mx-auto px-4 py-4 text-sm text-zinc-400">
      <a href="/" class="hover:text-white">Home</a>
      <span class="mx-1">›</span>
      <a href={`/series/${slug}`} class="hover:text-white">
        {series.title}
      </a>
      <span class="mx-1">›</span>
      <span>Chapter {chapterNumber}</span>
    </nav>

    <!-- TITLE -->
    <header class="max-w-3xl mx-auto px-4 mb-6">
      <h1 class="text-xl font-semibold">
        {series.title} Chapter {chapterNumber}
      </h1>
    </header>

    <!-- READER -->
   {chapterImages ? (
  <section class="max-w-3xl mx-auto px-2 sm:px-4">
    {chapterImages.images.map((img, i) => (
      <figure
        class="mb-2 bg-black"
        style={`aspect-ratio:${img.width}/${img.height}`}
      >
        <img
          src={img.src}
          alt={`${series.title} Chapter ${chapterNumber} Page ${i + 1}`}
          width={img.width}
          height={img.height}
          loading={i === 0 ? "eager" : "lazy"}
          decoding="async"
          class="w-full h-auto object-contain"
        />
      </figure>
    ))}
  </section>
) : (
  <section class="max-w-3xl mx-auto px-4 py-20 text-center text-zinc-400">
    <p>Chapter ini belum tersedia.</p>
  </section>
)}

    <!-- NAVIGATION -->
    <nav class="max-w-3xl mx-auto px-4 py-8 flex justify-between text-sm">
      {chapterNav.prev ? (
        <a
          href={`/series/${slug}/chapter/${chapterNav.prev.number}`}
          class="text-zinc-400 hover:text-white"
        >
          ← Chapter {chapterNav.prev.number}
        </a>
      ) : <span />}

      {chapterNav.next ? (
        <a
          href={`/series/${slug}/chapter/${chapterNav.next.number}`}
          class="text-zinc-400 hover:text-white"
        >
          Chapter {chapterNav.next.number} →
        </a>
      ) : <span />}
    </nav>

  </main>
</BaseLayout>