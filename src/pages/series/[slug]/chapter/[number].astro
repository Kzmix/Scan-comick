---
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  getAllSeriesSlugs,
  getSeriesBySlug,
  getChapterByNumber,
} from "@/lib/series";
import { getChapterImages } from "@/lib/chapter";

/* STATIC PATHS */
export async function getStaticPaths() {
  const paths = [];

  for (const slug of getAllSeriesSlugs()) {
    const series = getSeriesBySlug(slug);
    if (!series) continue;

    for (const ch of series.chapters) {
      paths.push({
        params: {
          slug,
          number: String(ch.number),
        },
      });
    }
  }

  return paths;
}

const { slug, number } = Astro.params;
const chapterNumber = Number(number);

const series = getSeriesBySlug(slug);
if (!series) throw new Error("Series not found");

const chapterNav = getChapterByNumber(series, chapterNumber);
if (!chapterNav) throw new Error("Chapter not found");

const chapterImages = getChapterImages(slug, chapterNumber);

const canonical = `https://example.com/series/${slug}/chapter/${chapterNumber}`;
---

<BaseLayout
  title={`${series.title} Chapter ${chapterNumber}`}
  description={`Baca ${series.title} Chapter ${chapterNumber}`}
  canonical={canonical}
>
  <main class="bg-zinc-950 text-zinc-100">

    <!-- BREADCRUMB -->
    <nav class="max-w-3xl mx-auto px-4 py-4 text-sm text-zinc-400">
      <a href="/" class="hover:text-white">Home</a>
      <span class="mx-1">›</span>
      <a href={`/series/${slug}`} class="hover:text-white">
        {series.title}
      </a>
      <span class="mx-1">›</span>
      <span>Chapter {chapterNumber}</span>
    </nav>

    <!-- TITLE -->
    <header class="max-w-3xl mx-auto px-4 mb-6">
      <h1 class="text-xl font-semibold">
        {series.title} Chapter {chapterNumber}
      </h1>
    </header>

    <!-- READER -->
   {chapterImages ? (
<section
  id="reader"
  class="max-w-3xl mx-auto px-0 sm:px-0"
>
  {chapterImages.images.map((img, i) => (
    <img
      src={img.src}
      alt={`${series.title} Chapter ${chapterNumber} Page ${i + 1}`}
      width={img.width}
      height={img.height}
      loading={i === 0 ? "eager" : "lazy"}
      decoding="async"
      draggable="false"
      class="block w-full h-auto mb-1"
    />
  ))}
</section>
) : (
  <section class="max-w-3xl mx-auto px-4 py-20 text-center text-zinc-400">
    <p>Chapter ini belum tersedia.</p>
  </section>
)}

    <!-- NAVIGATION -->
    <nav class="max-w-3xl mx-auto px-4 py-8 flex justify-between text-sm">
      {chapterNav.prev ? (
        <a
          href={`/series/${slug}/chapter/${chapterNav.prev.number}`}
          class="text-zinc-400 hover:text-white"
        >
          ← Chapter {chapterNav.prev.number}
        </a>
      ) : <span />}

      {chapterNav.next ? (
        <a
          href={`/series/${slug}/chapter/${chapterNav.next.number}`}
          class="text-zinc-400 hover:text-white"
        >
          Chapter {chapterNav.next.number} →
        </a>
      ) : <span />}
    </nav>

  </main>
  <!-- FLOATING SCROLL TO TOP -->
<button
  id="scroll-top"
  aria-label="Scroll to top"
  class="fixed bottom-24 right-4 z-40
         hidden
         rounded-full bg-zinc-800/80
         p-3 text-white
         backdrop-blur
         shadow-lg
         transition hover:bg-zinc-700"
>
  ↑
</button>

<script>
  (function () {
    const reader = document.getElementById("reader");
    const nav = document.querySelector("nav[aria-label='Bottom Navigation']");
    const scrollBtn = document.getElementById("scroll-top");

    if (!reader || !nav) return;

    let uiVisible = true;
    let touchStartY = 0;
    let touchMoved = false;

    // === TAP DETECTION (NO FALSE TRIGGER ON SCROLL) ===
    reader.addEventListener("touchstart", (e) => {
      touchStartY = e.touches[0].clientY;
      touchMoved = false;
    });

    reader.addEventListener("touchmove", (e) => {
      const diff = Math.abs(e.touches[0].clientY - touchStartY);
      if (diff > 10) touchMoved = true; // dianggap scroll
    });

    reader.addEventListener("touchend", () => {
      if (touchMoved) return;

      uiVisible = !uiVisible;

      // TOGGLE BOTTOM NAV
      nav.style.transform = uiVisible
        ? "translateY(0)"
        : "translateY(100%)";

      // TOGGLE SCROLL BUTTON
      if (scrollBtn) {
        scrollBtn.style.opacity = uiVisible ? "1" : "0";
        scrollBtn.style.pointerEvents = uiVisible ? "auto" : "none";
      }
    });

    // === SCROLL TO TOP BUTTON CLICK ===
    scrollBtn?.addEventListener("click", () => {
      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });
    });

    // === SHOW SCROLL BTN BASED ON SCROLL (ONLY IF UI VISIBLE) ===
    window.addEventListener(
      "scroll",
      () => {
        if (!scrollBtn || !uiVisible) return;

        if (window.scrollY > 600) {
          scrollBtn.classList.remove("hidden");
        } else {
          scrollBtn.classList.add("hidden");
        }
      },
      { passive: true }
    );
  })();
</script>
</BaseLayout>